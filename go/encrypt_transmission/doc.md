# 加密传输工具

本工具可以让两个人在不安全的通信信道上安全的传递信息

## 使用

> 参考`manual.md`

## 为什么想写这样一个工具

工作中遇到一个情况：需要将一个账上有钱的地址的私钥传输给另一个人。结果是用人工带一张抄录有助记词（部分）的纸条，纸条缺失部分另行通知。
这样的解决方案让人一言难尽...

我准备写一个命令行程序实现这一过程：

- 为什么不使用现有工具：因为目标私钥对应地址上真有钱，不确定现有工具是否绝对可靠
- 我们会提供一些平台的可执行程序，但我们还是建议你自行编译

编写技术验证demo遇到问题：最新版本的go（1.25）和ethereum（1.16）无法匹配：

- 因为我们没有使用以太坊的默认椭圆曲线(secp256k1)，将ethereum版本降低至1.13解决

## 设计

使用场景：甲想要将一段内容传输给乙。
乙需要向甲提供一个公钥，甲使用公钥加密想要传递的内容并将密文提供给乙，乙使用向甲提供的公钥对应的私钥解密密文，得到消息明文。
（公钥和密文可以通过聊天软件传输）

程序功能：

- 对甲来说：使用提供的公钥加密指定内容
- 对乙来说：生成一对公私钥（可选）、使用私钥解密指定内容

程序设计：
启动后等待输入指令，生成的公私钥写成文件，再来一个文件用以提供要加密的明文，加密后的密文也写文件，解密的时候参数都从文件读；
要求使用者将参数文件修改成默认文件名

## 技术准备

### 椭圆曲线密码学

Elliptic Curve Cryptography 椭圆曲线密码学(ECC)
Elliptic Curve Digital Signature Algorithm 椭圆曲线数字签名算法(ECDSA)

背景知识：

- 椭圆曲线上的一个点，我们为其定义了加法和乘法运算
- 假设公钥为K、私钥为k、曲线基点为G，有K=kG，（大写表示公开）
- 私钥：256 bits随机数；公钥：512 bits；地址：160 bits
- 私钥 -(椭圆曲线乘法)-> 公钥 -(Keccak-256哈希 & 取后20字节)-> 地址

#### 加、解密

使用随机数r将明文消息M生成密文C，该密文是一个点对：
C = {rG, M+rK}

解密则是使用C、k还原M的过程：
M = M + rkG - rkG = (M + rK) - k(rG)
即用C的第二个点减去k乘以第一个点，得到的结果就是明文M

#### 签名验签

签名：

- 对明文做hash，得到H（256 bits）
- K=k*G，取r=K.x
- s = k⁻¹ * (H + r * k) mod n
    - k⁻¹ 是 k 在模 n 下的模逆元
    - n 是曲线的阶
- v: 标识K.y是奇数还是偶数
- 签名结果：(r, s, v)

验签：可以拿到消息hash H和签名结果(r, s, v)

- 根据H和签名可以恢复出公钥，根据公钥计算出地址A，即可以确认这个签名是A签的

### DH交换算法(Diffie-Hellman)

DH算法是一种在不安全的通信信道上安全地交换密钥的协议，
算法只协商密钥，不负责加密

原理是在数学问题中，正着计算过去相对容易，而反着推则非常困难。

过程：

- 甲和乙约定两个数p和g
- 甲使用随机数a计算 A = g^a (mod p)
- 乙使用随机数b计算 B = g^b (mod p)
- 甲、乙交换A、B
- 甲计算 S = B^a (mod p)
- 乙计算 S = A^b (mod p)
- 在数学上，两人计算出的S相同

ECDH算法则是结合了椭圆曲线的密钥协商算法

### 混合加密

非对称加密的数学算法在实际应用中有着诸多限制：

- 对原文长度有要求，加密的数据量不能超过密钥阶数，即一个2048位的密钥单次只能加密256字节的数据
- 速度慢，考虑到cpu的针对性指令集，对称加密比非对称加密快100～1000倍

所以在实际应用中，即使宣称使用非对称加密技术，其底层实际用于加密的算法，大多也是对称加密，
例如本工具使用的以太坊go sdk(ecies)就是这样
